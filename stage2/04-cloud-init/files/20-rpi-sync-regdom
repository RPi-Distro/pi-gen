#!/bin/bash
set -eu

# Exit cleanly if Netplan cfg dir isn't present
[ -d /etc/netplan ] || exit 0

# Extract the first configured regulatory-domain from netplan YAML,
# checking highest-priority files first (reverse alphabetical, e.g. 99-* overrides 00-*).
COUNTRY="$(
  while IFS= read -r -d '' file; do
    sed -nE 's/^[[:space:]]*regulatory-domain:[[:space:]]*"?(..)"?.*/\1/p' "$file" && exit 0
  done < <(find /etc/netplan -maxdepth 1 -type f \( -name '*.yml' -o -name '*.yaml' \) -print0 | sort -z -r)
)"

[ -z "${COUNTRY:-}" ] && exit 0  # nothing to sync

case "$COUNTRY" in
  [A-Za-z][A-Za-z]|00) : ;;
  *) exit 0 ;;
esac

CMDLINE="/boot/firmware/cmdline.txt"
if [ -f "$CMDLINE" ]; then
  if grep -q '\bcfg80211\.ieee80211_regdom=' "$CMDLINE"; then
    # replace existing
    sed -i -E "s/\bcfg80211\.ieee80211_regdom=\S+/cfg80211.ieee80211_regdom=${COUNTRY}/" "$CMDLINE"
  else
    # append (keep single line)
    sed -i "s/$/ cfg80211.ieee80211_regdom=${COUNTRY}/" "$CMDLINE"
  fi
fi

if systemctl is-active --quiet NetworkManager; then
  nmcli radio wifi on
else
  rfkill unblock wifi
  if [ -f /var/lib/NetworkManager/NetworkManager.state ]; then
    sed -i 's/^WirelessEnabled=.*/WirelessEnabled=true/' /var/lib/NetworkManager/NetworkManager.state
  fi
fi

# Clear any persistent rfkill blocks on wlan interfaces
for filename in /var/lib/systemd/rfkill/*:wlan ; do
  if ! [ -e "$filename" ]; then
    continue
  fi
  echo 0 > "$filename"
done

exit 0
